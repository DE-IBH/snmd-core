if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGWidget==="undefined"){Scotty.SVGWidget={}}(function($){"use strict";this.Impl={};this.Widgets={};this.srRegisterImpl=function(name,impl){this.Impl[name]=impl}.bind(this);this.srLookupImpl=function(name){return this.Impl[name]}.bind(this);this.srRegisterWidget=function(name,widget){this.Widgets[name]=widget}.bind(this);this.srLookupWidget=function(name){return this.Widgets[name]}.bind(this);this.srClassOpts=function(desc,impl){var cls={base:["snmd-bcl-"+impl],state:["snmd-scl-","snmd-scl-"+impl+"-"]};if(typeof desc.type!=="undefined"){cls.base.push("snmd-bcl-"+desc.type)}if(typeof desc.bcls!=="undefined"){cls.base.push.apply(cls.base,desc.bcls)}if(typeof desc.bcl!=="undefined"){cls.base.push(desc.bcl)}if(typeof desc.scls!=="undefined"){cls.state.push.apply(cls.state,desc.scls)}if(typeof desc.scl!=="undefined"){cls.state.push(desc.scl)}return cls}.bind(this);this.srCreateWidget=function(root,svg,desc){if(typeof desc.type==="undefined"){console.error("Widget "+svg.id+" has no type set!");return}if(typeof this.Widgets[desc.type]==="undefined"){console.error("Widget "+svg.id+" has unknown type: "+desc.type);return}try{var obj=new this.Widgets[desc.type](root,svg,desc,this.Widgets[desc.type]);if(typeof desc.topics!=="undefined"){desc.topics.forEach(function(topic){Scotty.MQTT.srRegisterTopic(topic,obj)})}}catch(err){console.error("Failed to create widget "+svg.id+" of type "+desc.type+": "+err.message);return}}.bind(this)}).call(Scotty.SVGWidget,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.Core==="undefined"){Scotty.Core={}}(function($){"use strict";var version="0.1",config;this.si_prefs=["T","G","M","k",""];this.si_facts=[Math.pow(10,12),Math.pow(10,9),Math.pow(10,6),Math.pow(10,3),1];this.genid=0;this.srVersion=function(){return version};this.srURLParam=function(name,defval){var results=new RegExp("[?&]"+name+"=([^&#/]*)([&#/]|$)").exec(window.location.href);if(results&&results[1]){return decodeURIComponent(results[1])}return defval};this.srConfigLoaded=function(json){this.config=json;console.debug("Loading "+this.config.default_view);$.ajax({global:false,url:this.config.default_view+"?nonce="+Math.random(),dataType:"json",success:function(json){Scotty.GUI.srInit(json);if(typeof this.config.mqttws_host==="undefined"){this.config.mqttws_host=window.location.hostname}if(typeof this.config.mqttws_port==="undefined"){this.config.mqttws_port=9001}Scotty.MQTT.srInit(this.config.mqttws_host,this.config.mqttws_port)}.bind(this),error:function(jqXHR,textStatus,errorThrown){console.error("Failed to load view list: "+textStatus+" - "+errorThrown)}.bind(this)})};this.srInitLoad=function(configURI,failfn){console.debug("Loading "+configURI);$.ajax({global:false,url:configURI+"?nonce="+Math.random(),dataType:"json",success:this.srConfigLoaded.bind(this),error:failfn})};this.srInit=function(){console.info("Initializing Scotty REVOLUTION "+version);var configName=this.srURLParam("config","default");if(configName!=="default"){$("#snmd-title").text(configName)}else{$("#snmd-title").text(window.location.host)}this.srInitLoad("configs/"+configName+".json",function(){this.srInitLoad("configs/default.json",function(jqXHR,textStatus,errorThrown){console.error("Failed to load configuration: "+textStatus+" - "+errorThrown)})}.bind(this))};this.srSiFormatNum=function(value,unit,defstr,fracts){if(typeof value==="undefined"){return defstr}if(isNaN(value)){return defstr}if(typeof fracts==="undefined"||isNaN(fracts)){fracts=0}var j=4;var f=1;for(var i=0;i<this.si_facts.length;i++){if(value>=this.si_facts[i]*.99){j=i;break}}return sprintf("%."+fracts+"f%s%s",value/this.si_facts[j],this.si_prefs[j],unit)}.bind(this);this.srNagStateColor=function(state){if(typeof state==="undefined"){return"Grey"}if(state==0){return"LimeGreen"}if(state==1){return"Gold"}if(state==2){return"Crimson"}return"Orange"};this.srGenID=function(prefix){this.genid+=1;return"snmd-genid-"+prefix+"-"+this.genid}.bind(this)}).call(Scotty.Core,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.MQTT==="undefined"){Scotty.MQTT={}}(function($){"use strict";var client,flashTO,reconnTO,topics={};this.srReconnect=function(){console.debug("Reconnecting...");this.srConnect()};this.srRegisterTopic=function(topic,watcher){if(typeof this.topics==="undefined"){this.topics={}}if(typeof this.topics[topic]==="undefined"){this.topics[topic]=[watcher];if(typeof this.client!=="undefined"&&this.client.isConnected()){this.client.subscribe(topic)}}else{this.topics[topic].push(watcher)}};this.srStatus=function(color){$("#snmd-hb").css("background",color)}.bind(this);this.srConnect=function(){this.srStatus("yellow");console.debug("Connecting to MQTT broker "+this.broker_host+":"+this.broker_port+"...");this.client=new Paho.MQTT.Client(this.broker_host,this.broker_port,"",this.clientId);this.client.disconnect=function(){console.error("Disconnected");this.srStatus("#7f0000")}.bind(this);this.client.onConnectionLost=function(res){this.srStatus("#ff0000");console.error("Connection Lost: "+res.errorMessage);if(this.reconnTO){clearTimeout(this.reconnTO)}this.srStatus("orange");this.reconnTO=setTimeout(this.srConnect.bind(this),5e3)}.bind(this);this.client.onMessageArrived=function(msg){this.srStatus("#00ff00");setTimeout(function(){this.srStatus("#007f00")}.bind(this),100);if(typeof this.topics[msg.destinationName]!=="undefined"){for(var i=0;i<this.topics[msg.destinationName].length;i++){var watcher=this.topics[msg.destinationName][i];try{watcher.handleUpdate.call(watcher,msg.destinationName,msg.payloadString)}catch(err){console.error("Failure updating "+msg.destinationName+" in "+watcher+": "+err.message);return}}}else{console.warn("Received MQTT message for unknown topic "+msg.destinationName+"!")}return 1}.bind(this);var me=this;this.client.connect({onSuccess:function(){console.info("Connected to mqtt://"+this.broker_host+":"+this.broker_port);this.srStatus("#7f0000");for(var topic in this.topics){this.client.subscribe(topic)}}.bind(this),onFailure:function(res){if(this.reconnTO){clearTimeout(this.reconnTO)}this.srStatus("orange");this.reconnTO=setTimeout(this.srConnect.bind(this),5e3)}.bind(this)})};this.srInit=function(host,port,clientId){if(typeof clientId==="undefined"){clientId="RND"+Math.floor(Math.random()*16777215).toString(16)}console.debug("MQTT broker = "+host+":"+port);console.debug("MQTT clientId = "+clientId);this.broker_host=host;this.broker_port=Number(port);this.clientId=clientId;this.srConnect()}}).call(Scotty.MQTT,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.GUI==="undefined"){Scotty.GUI={}}(function($){"use strict";var idCounter=0;this.TO_SCREEN=6e5;this.TO_SWITCH=3e4;this.screenState=0;this.viewStates={};this.viewFinalStates={};this.currentStep=0;this.srScreenTimeOut=function(){if(this.screenState===0){this.screenState+=1;$(document.body).addClass("on-screensaver")}$(".srViews").each(function(){var a=$(this).children(".srViewsNav").find("a");var cur=0;for(var i=0;i<a.length;i++){if(a[i].hash===Scotty.GUI.currentView){cur=i}}cur+=1;if(cur>=a.length){cur=0}a[cur].click()});this.screenTimeOut=window.setTimeout(this.srScreenTimeOut,this.TO_SWITCH)}.bind(this);this.srStateChanged=function(root,svg,state){this.viewStates[root][svg]=state;if(this.viewFinalStates[root]<state){this.viewFinalStates[root]=state;$("#switch-"+root).css("color",Scotty.Core.srNagStateColor(this.viewFinalStates[root]))}else{if(this.viewFinalStates[root]>state){var fs=state;Object.keys(this.viewStates[root]).forEach(function(k){if(Scotty.GUI.viewStates[root][k]>fs){fs=Scotty.GUI.viewStates[root][k]}});this.viewFinalStates[root]=fs;$("#switch-"+root).css("color",Scotty.Core.srNagStateColor(this.viewFinalStates[root]))}}}.bind(this);this.srInit=function(views){$(".srViews").each(function(){var views2id={};var nav=$(this).children(".srViewsNav");Object.keys(views).forEach(function(k){views2id[k]="srView-"+(idCounter+=1).toString(16);Scotty.GUI.viewStates[views2id[k]]={};Scotty.GUI.viewFinalStates[views2id[k]]=-1;nav.append('<li><a id="switch-'+views2id[k]+'" href="#'+views2id[k]+'"><span>'+views[k]["title"]+"</span></a></li>")});var div=$("#snmd-views");var dps=360/Object.keys(views).length;var step=0;var r=Object.keys(views).length>1?1906/2/Math.tan(Math.PI/Object.keys(views).length):0;var oy=($("#snmd-views").height()-30-1038)/2+30;Object.keys(views).forEach(function(k){div.append('<div class="svgview" id="'+views2id[k]+'"></div>');if($(document.body).hasClass("enable-3d")){$("#"+views2id[k]).css("transform","rotateY("+dps*step+"deg) translateZ("+r+"px)")}switch(views[k]["render"]){case"html":Scotty.HTML.srLoadHTML(views2id[k],views[k]["url"],views[k]["reload"]);break;case"svg":default:Scotty.SVG.srLoadSVG(views2id[k],views[k]["url"]);break}step+=1});$("#snmd-views").css("transform-origin","100% 50% 50%");var tabDivs=div;var alignView=function(){var f=1;if($(document.body).hasClass("enable-3d")){$("#snmd-views").css("transform","scale("+f+") translateZ(-"+r+"px) rotateY("+-1*dps*Scotty.GUI.currenStep+"deg)")}}.bind(this);nav.find("a").click(function(event){console.debug("Viewing "+this.hash);Scotty.GUI.currentView=this.hash;div.children().removeClass("current").filter(this.hash).removeClass("next").removeClass("prev").addClass("current");$(Scotty.GUI.currentView).prevAll().removeClass("next").addClass("prev");$(Scotty.GUI.currentView).nextAll().removeClass("prev").addClass("next");nav.find("a").removeClass("selected").filter(this).addClass("selected");Scotty.GUI.currenStep=$(Scotty.GUI.currentView).prevAll().length;alignView();return false}).filter(":first").click();if(window.location.hash!=="undefined"){var nth=parseInt(window.location.hash.replace(/^#srView-/,""))-1;var a=nav.find("a:eq("+nth+")").click()}$("#snmd-ctrl").find("a").click(function(event){console.debug("Control: "+this.hash);return false}).filter(":first").click()}).bind(this);window.setInterval(function(){$("div#snmd_clock").text(moment().format("YYYY-MM-DDTHH:mm:ssZZ"))},1e3);this.screenTimeOut=window.setTimeout(this.srScreenTimeOut,this.TO_SCREEN);$(document).mousemove(function(){this.screenState=0;if(typeof this.screenTimeOut!=="undefined"){window.clearTimeout(this.screenTimeOut);this.screenTimeOut=window.setTimeout(this.srScreenTimeOut,this.TO_SCREEN);$(document.body).removeClass("on-screensaver")}}.bind(this));$(document).keypress(function(ev){this.screenState=0;if(typeof this.screenTimeOut!=="undefined"){window.clearTimeout(this.screenTimeOut);this.screenTimeOut=window.setTimeout(this.srScreenTimeOut,this.TO_SCREEN)}if(ev.which>47&&ev.which<58){var key=ev.which==48?"10":String.fromCharCode(ev.which);$('a[href="#srView-'+key+'"]').click()}}.bind(this))}.bind(this)}).call(Scotty.GUI,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.HTML==="undefined"){Scotty.HTML={}}(function($){"use strict";this.srLoadHTML=function(id,url,reload){console.debug("Loading #"+id+": "+url);var iframe=$("<iframe>",{src:url,width:"95%",height:"95%",scrolling:"no"}).addClass("htmlview").appendTo($("#"+id));if(typeof reload!=="undefined"){window.setInterval(function(){iframe[0].contentWindow.location.reload(false)},reload*1e3)}}}).call(Scotty.HTML,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVG==="undefined"){Scotty.SVG={}}(function($){"use strict";this.srParseSVG=function(svg,error){if(error){console.error("Failed loading SVG: "+error);svg.text(10,20,error,{fill:"red"});return}svg.root().setAttribute("width","100%");svg.root().setAttribute("height","100%");$('[id^="sr_"]',svg.root()).each(function(){var json;try{json=JSON.parse($(this).find("desc").text())}catch(err){console.error("JSON error in description for graph #"+this.id+": "+err.message);console.debug($(this).find("desc").text())}if(json){Scotty.SVGWidget.srCreateWidget(svg,this,json)}})};this.srLoadSVG=function(id,url){console.debug("Loading #"+id+": "+url);$("#"+id).svg({loadURL:url+"?nonce="+Math.random(),"max-width":"100%","max-height":"100%",onLoad:this.srParseSVG})};this.srRelToAbsPos=function(root,svg){var rrect=root.getBoundingClientRect();var crect=svg.getBoundingClientRect();var ctm=svg.getScreenCTM();return{x:ctm.a*crect.left+ctm.c*crect.top+ctm.e+rrect.left,y:ctm.b*crect.left+ctm.d*crect.top+ctm.f+rrect.top}};this.srGetStrokeFill=function(svg){var opts=["stroke","strokeLinecap","strokeLinejoin","strokeWidth","fill"];var res=[];for(var i=0;i<opts.length;i++){console.warn(opts[i]+" => "+svg.style[opts[i]]);res[opts[i]]=svg.style[opts[i]]}return res}}).call(Scotty.SVG,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.StrokeWidth==="undefined"){Scotty.SVGImpl.StrokeWidth={}}(function($){"use strict";var StrokeWidth=function(root,svg,opts,qtip){this.root=root;this.opts=opts;this.el=svg;this.opts.cls.base.forEach(function(cl){this.el.classList.add(cl)},this);this.el.style.stroke="";this.el.style.fill="";if(typeof qtip!=="undefined"){this.el.qtip(qtip)}};StrokeWidth.prototype.update=function(val,state){if(this.last_val===val&&this.last_state===state){return}this.opts.cls.state.forEach(function(cl){this.el.classList.remove(cl+this.last_state)},this);this.opts.cls.state.forEach(function(cl){this.el.classList.add(cl+state)},this);var f=val/this.opts.max;if(f<this.opts.width[0]){f=this.opts.width[0]}else{if(f>this.opts.width[1]){f=this.opts.width[1]}}this.el.style.StrokeWidth=f+"px";this.last_val=val;this.last_state=state};Scotty.SVGWidget.srRegisterImpl("StrokeWidth",StrokeWidth)}).call(Scotty.SVGImpl.StrokeWidth,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Transform==="undefined"){Scotty.SVGImpl.Transform={}}(function($){"use strict";var Transform=function(root,svg,opts,qtip){this.root=root;this.opts=opts;this.el=svg;this.opts.cls.base.forEach(function(cl){this.el.classList.add(cl)},this);this.el.style.stroke="";this.el.style.fill="";if(typeof qtip!=="undefined"){this.el.qtip(qtip)}};Transform.prototype.update=function(val,state){if(this.last_val===val&&this.last_state===state){return}this.opts.cls.state.forEach(function(cl){this.el.classList.remove(cl+this.last_state)},this);this.opts.cls.state.forEach(function(cl){this.el.classList.add(cl+state)},this);var f=val/this.opts.max;this.el.style.transform=this.opts.transform.split("%").join(f);this.last_val=val;this.last_state=state};Scotty.SVGWidget.srRegisterImpl("Transform",Transform)}).call(Scotty.SVGImpl.Transform,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Gradient==="undefined"){Scotty.SVGImpl.Gradient={}}(function($){"use strict";var Gradient=function(root,svg,opts,qtip){this.opts=opts;this.root=root;this.svg=svg;opts.cls.base.forEach(function(cl){this.svg.classList.add(cl)},this);if(typeof qtip!=="undefined"){this.svg.qtip(qtip)}var s=[];for(var stop in this.opts.stops){s.push([this.opts.stops[stop],"#404040"])}this.grad=root.linearGradient(null,Scotty.Core.srGenID("lgrd"),s,this.opts.coords[0],this.opts.coords[1],this.opts.coords[2],this.opts.coords[3]);this.stops={};var i=0;for(var stop in this.opts.stops){this.stops[this.opts.stops[stop]]=this.grad.childNodes[i];i++}svg.style.fill="url(#"+this.grad.id+")";opts.cls.base.forEach(function(cl){svg.classList.add(cl);this.grad.classList.add(cl)},this)};Gradient.prototype.update=function(stops,state){if(typeof stops==="undefined"){return}for(var stop in stops){if(typeof stops[stop]!=="undefined"){this.stops[stop].setAttribute("stop-color","hsl("+stops[stop]+",100%,50%)")}else{this.stops[stop].setAttribute("stop-color","#404040")}}};Scotty.SVGWidget.srRegisterImpl("Gradient",Gradient)}).call(Scotty.SVGImpl.Gradient,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Gauge==="undefined"){Scotty.SVGImpl.Gauge={}}(function($){"use strict";var Gauge=function(root,svg,opts,lines,qtip){this.opts=opts;this.lines=lines;this.cls=opts.cls.base;this.root=root;opts.dim={id:svg.id,x:svg.x.baseVal.value,y:svg.y.baseVal.value+svg.height.baseVal.value,width:svg.width.baseVal.value,height:svg.height.baseVal.value};root.remove(svg);this.pathdata=new SVGPathData("m "+opts.dim.x+","+opts.dim.y+" a "+opts.dim.width/2+","+opts.dim.height+" 0 0 1 "+opts.dim.width+",0");if(typeof qtip!=="undefined"){this.rect.qtip(qtip)}this.last_stroke="";this.last_val=-1;var alpha=Math.PI;this.pathdata.commands[1].x=(1-Math.cos(alpha/2))*2*this.pathdata.commands[1].rX;this.pathdata.commands[1].y=-1*Math.sin(alpha)*this.pathdata.commands[1].rY;this.root.path(this.pathdata.encode(),{"class":this.cls.map(function(cl){return cl+"-BG"}).join(" ")})};Gauge.prototype.update=function(val,max,state){if(val===this.last_val&&state===this.last_state){return}if(val>max){val=max}var alpha=val/max*Math.PI;this.pathdata.commands[1].x=(1-Math.cos(alpha/2))*2*this.pathdata.commands[1].rX;this.pathdata.commands[1].y=-1*Math.sin(alpha)*this.pathdata.commands[1].rY;if(state!==this.last_state){this.opts.cls.state.forEach(function(cl){var idx=this.cls.indexOf(cl+this.last_state);if(idx>-1){this.cls.splice(idx,1)}},this);this.opts.cls.state.forEach(function(cl){this.cls.push(cl+state)},this)}if(typeof this.svg!=="undefined"){this.root.remove(this.svg)}this.svg=this.root.path(this.pathdata.encode(),{id:this.opts.dim.id,"class":this.cls.join(" ")});this.last_val=val;if(state!==this.last_state){this.last_state=state;Scotty.GUI.srStateChanged(this.root._svg.parentElement.id,this.opts.dim.id,state)}};Scotty.SVGWidget.srRegisterImpl("Gauge",Gauge)}).call(Scotty.SVGImpl.Gauge,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Text==="undefined"){Scotty.SVGImpl.Text={}}(function($){"use strict";var Text=function(root,svg,opts,qtip){this.opts=opts;this.root=root;this.txt=svg;this.txt.style.stroke="";this.txt.style.fill="";this.txt.textContent="?";opts.cls.base.forEach(function(cl){this.txt.classList.add(cl)},this);if(typeof qtip!=="undefined"){this.txt.qtip(qtip)}};Text.prototype.update=function(val,state,formatNumeric){if(this.last_val===val&&state===this.last_state){return}if(typeof formatNumeric==="undefined"){formatNumeric=true}this.txt.textContent=formatNumeric?Scotty.Core.srSiFormatNum(val,this.opts.uom,"-",this.opts.fracts):val;this.last_val=val;if(state!==this.last_state){this.opts.cls.state.forEach(function(cl){this.txt.classList.remove(cl+this.last_state)},this);this.opts.cls.state.forEach(function(cl){this.txt.classList.add(cl+state)},this);this.last_state=state;Scotty.GUI.srStateChanged(this.root._svg.parentElement.id,this.txt.id,state)}};Scotty.SVGWidget.srRegisterImpl("Text",Text)}).call(Scotty.SVGImpl.Text,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Class==="undefined"){Scotty.SVGImpl.Class={}}(function($){"use strict";var Class=function(root,svg,opts,qtip){this.root=root;this.opts=opts;this.el=svg;this.opts.cls.base.forEach(function(cl){this.el.classList.add(cl)},this);if(typeof qtip!=="undefined"){this.el.qtip(qtip)}};Class.prototype.update=function(state){if(state===this.last_state){return}this.opts.cls.state.forEach(function(cl){this.el.classList.remove(cl+this.last_state)},this);this.opts.cls.state.forEach(function(cl){this.el.classList.add(cl+state)},this);this.last_state=state};Scotty.SVGWidget.srRegisterImpl("Class",Class)}).call(Scotty.SVGImpl.Class,jQuery);if(typeof Scotty==="undefined"){Scotty={}}if(typeof Scotty.SVGImpl==="undefined"){Scotty.SVGImpl={}}if(typeof Scotty.SVGImpl.Chart==="undefined"){Scotty.SVGImpl.Chart={}}(function($){"use strict";var Chart=function(root,svg,opts,lines,qtip){this.opts=opts;this.lines=lines;if(typeof this.opts.lcls!=="undefined"){for(var l=0;l<this.lines.length;l++){var classes=this.opts.lcls.slice(0);this.opts.lcls.forEach(function(cl){classes.push(cl+"-"+this.lines[l].name)},this);this.lines[l].style={"class":classes.join(" ")}}}if(typeof this.opts.mcls!=="undefined"){this.maxline_style={"class":this.opts.mcls.join(" ")}}this.root=root;opts.dim={id:svg.id,x:svg.x.baseVal.value,y:svg.y.baseVal.value,width:svg.width.baseVal.value,height:svg.height.baseVal.value};root.remove(svg);this.rect=root.rect(opts.dim.x,opts.dim.y,opts.dim.width,opts.dim.height,{id:opts.dim.id,"class":opts.cls.base.join(" ")});if(typeof qtip!=="undefined"){this.rect.qtip(qtip)}this.txt=[root.text(opts.dim.x,opts.dim.y,"")];if(lines.length>1){this.txt[1]=root.text(opts.dim.x+opts.dim.width,opts.dim.y,"")}for(var l=0;l<this.txt.length;l++){if(typeof this.opts.tcls!=="undefined"){this.opts.tcls.forEach(function(cl){this.txt[l].classList.add(cl);this.txt[l].classList.add(cl+"-"+this.lines[l].name)},this)}}this.data_tswin=(opts.dim.width-6)/opts.dpi;this.data_ts=[];this.data_lines=[];this.data_svg=[];for(var i=0;i<lines.length;i++){this.data_lines[i]=[]}this.axis_maxlines=[];this.axis_maxlasts=[]};Chart.prototype.update=function(ts,data,state){var stroke=Scotty.Core.srNagStateColor(state);this.data_ts.push(ts);var maxy=typeof this.opts.axis[0].max==="undefined"?0:this.opts.axis[0].max;for(var i=0;i<this.data_lines.length;i++){this.data_lines[i].push(data[i]);maxy=Math.max(maxy,Math.max.apply(null,this.data_lines[i]))}var shift_ts;var shift_data=[];while(this.data_ts[0]<ts-this.data_tswin){shift_ts=this.data_ts.shift();for(var i=0;i<this.data_lines.length;i++){shift_data[i]=this.data_lines[i].shift()}}if(typeof shift_ts!=="undefined"){if(this.data_ts.length>0){var nts=ts-this.data_tswin;this.data_ts.unshift(nts);for(var i=0;i<this.data_lines.length;i++){this.data_lines[i].unshift(shift_data[i]+(this.data_lines[i][0]-shift_data[i])*(nts-shift_ts)/(this.data_ts[1]-shift_ts))}}}if(typeof this.opts.axis[0].max!=="undefined"){if(this.axis_maxlasts[0]!=maxy){this.axis_maxlasts[0]=maxy}}if(this.opts.axis[0].scale=="log"){maxy=Math.log10(maxy)}var ox=this.opts.dim.x+this.opts.dim.width-3;var oy=this.opts.dim.y+this.opts.dim.height-3;var my=this.opts.dim.height-20;var fy=my/maxy;var clean=[];var last=[];if(typeof this.opts.axis[0].max!=="undefined"){var numlines=this.opts.axis[0].max<this.axis_maxlasts[0]?Math.floor(this.axis_maxlasts[0]/this.opts.axis[0].max):0;for(var i=0;i<numlines;i++){if(typeof this.axis_maxlines[i]!=="undefined"){clean.push(this.axis_maxlines[i])}var y=oy-(i+1)*this.opts.axis[0].max*fy;this.axis_maxlines[i]=this.root.line(this.opts.dim.x,y,this.opts.dim.x+this.opts.dim.width,y,this.maxline_style)}if(this.axis_maxlines.length>numlines){clean=clean.concat(this.axis_maxlines.splice(numlines,this.axis_maxlines.length-numlines))}}for(var l=0;l<this.data_lines.length;l++){var points=[];var is_polygon=true;if(typeof this.data_svg[l]!=="undefined"){var style=window.getComputedStyle(this.data_svg[l]);if(style["fill"]==="none"||style["fill"]===""){is_polygon=false}}for(var t=0;t<this.data_ts.length;t++){var x=ox+(this.data_ts[t]-ts)*this.opts.dpi;if(is_polygon&&t==0){points.push([x,oy])}var v=this.data_lines[l][t];if(typeof v==="undefined"){v=0}if(isNaN(v)){v=0}if(this.opts.axis[0].scale=="log"){if(v>1){v=Math.log10(v)}else{v=0}}v*=fy;points.push([x,oy-v]);if(t==this.data_ts.length-1){if(is_polygon){points.push([x,oy])}last[l]=this.data_lines[l][t]}}if(typeof this.data_svg[l]!=="undefined")clean.push(this.data_svg[l]);try{if(is_polygon){this.data_svg[l]=this.root.polygon(points,this.lines[l].style)}else{this.data_svg[l]=this.root.polyline(points,this.lines[l].style)}}catch(err){console.error("Failed to create poly for "+this.rect.id)}if(typeof this.txt[l]!=="undefined"){this.txt[l].textContent=Scotty.Core.srSiFormatNum(last[l],typeof this.lines[l].unit==="undefined"?"":this.lines[l].unit,"-")}}while(clean.length){var s=clean.shift();this.root.remove(s)}if(state!==this.last_state){this.opts.cls.state.forEach(function(cl){this.rect.classList.remove(cl+this.last_state)},this);this.opts.cls.state.forEach(function(cl){this.rect.classList.add(cl+state)},this);this.last_state=state;Scotty.GUI.srStateChanged(this.rect.parentElement.parentElement.id,this.rect.id,state)}};Scotty.SVGWidget.srRegisterImpl("Chart",Chart)}).call(Scotty.SVGImpl.Chart,jQuery);
//# sourceMappingURL=dist/snmd-core.min.map