define(["snmd-core/js/Core","snmd-core/js/GUI","js-logger","jquery"],function(t,s,i,a){"use strict";var h=function(t,s,i,h,e){this.opts=i,this.lines=h;var l;if(void 0!==this.opts.lcls)for(l=0;l<this.lines.length;l++){var o=this.opts.lcls.slice(0);this.opts.lcls.forEach(function(t){o.push(t+"-"+this.lines[l].name)},this),this.lines[l].style={class:o.join(" ")}}if(void 0!==this.opts.mcls&&(this.maxline_style={class:this.opts.mcls.join(" ")}),this.root=t,i.dim={id:s.id,x:s.x.baseVal.value,y:s.y.baseVal.value,width:s.width.baseVal.value,height:s.height.baseVal.value},t.remove(s),this.rect=t.rect(i.dim.x,i.dim.y,i.dim.width,i.dim.height,{id:i.dim.id,class:i.cls.base.join(" ")}),void 0!==e){var d=a(this.rect);d.addClass("snmd-bcl-Widget"),d.qtip(e)}for(this.txt=[t.text(i.dim.x,i.dim.y,"")],h.length>1&&(this.txt[1]=t.text(i.dim.x+i.dim.width,i.dim.y,"")),l=0;l<this.txt.length;l++)void 0!==this.opts.tcls&&this.opts.tcls.forEach(function(t){this.txt[l].classList.add(t),this.txt[l].classList.add(t+"-"+this.lines[l].name)},this);this.data_tswin=(i.dim.width-6)/i.dpi,this.data_ts=[],this.data_lines=[],this.data_svg=[];var n;for(n=0;n<h.length;n++)this.data_lines[n]=[];this.axis_maxlines=[],this.axis_maxlasts=[]};return h.prototype.update=function(a,h,e){this.data_ts.push(a);var l,o=void 0===this.opts.axis[0].max?0:this.opts.axis[0].max;for(l=0;l<this.data_lines.length;l++)("number"!=typeof(C=h[l])||isNaN(C))&&(C=0),this.data_lines[l].push(C),o=Math.max(o,Math.max.apply(null,this.data_lines[l]));for(var d,n=[];this.data_ts[0]<a-this.data_tswin;)for(d=this.data_ts.shift(),l=0;l<this.data_lines.length;l++)n[l]=this.data_lines[l].shift();if(void 0!==d&&this.data_ts.length>0){var r=a-this.data_tswin;for(this.data_ts.unshift(r),l=0;l<this.data_lines.length;l++)this.data_lines[l].unshift(n[l]+(this.data_lines[l][0]-n[l])*(r-d)/(this.data_ts[1]-d))}void 0!==this.opts.axis[0].max&&this.axis_maxlasts[0]!==o&&(this.axis_maxlasts[0]=o),"log"===this.opts.axis[0].scale&&(o=Math.log10(o));var x=this.opts.dim.x+this.opts.dim.width-3,m=this.opts.dim.y+this.opts.dim.height-3,p=(this.opts.dim.height-20)/o,c=[],_=[];if(void 0!==this.opts.axis[0].max){var v=this.opts.axis[0].max<this.axis_maxlasts[0]?Math.floor(this.axis_maxlasts[0]/this.opts.axis[0].max):0;for(l=0;l<v;l++){void 0!==this.axis_maxlines[l]&&c.push(this.axis_maxlines[l]);var f=m-(l+1)*this.opts.axis[0].max*p;this.axis_maxlines[l]=this.root.line(this.opts.dim.x,f,this.opts.dim.x+this.opts.dim.width,f,this.maxline_style)}this.axis_maxlines.length>v&&(c=c.concat(this.axis_maxlines.splice(v,this.axis_maxlines.length-v)))}var g;for(g=0;g<this.data_lines.length;g++){var u=[],y=!0;if(void 0!==this.data_svg[g]){var w=window.getComputedStyle(this.data_svg[g]);"none"!==w.fill&&""!==w.fill||(y=!1)}var b;for(b=0;b<this.data_ts.length;b++){var j=x+(this.data_ts[b]-a)*this.opts.dpi;y&&0===b&&u.push([j,m]);var C=this.data_lines[g][b];"log"===this.opts.axis[0].scale&&(C=C>1?Math.log10(C):0),C*=p,u.push([j,m-C]),b===this.data_ts.length-1&&(y&&u.push([j,m]),_[g]=this.data_lines[g][b])}void 0!==this.data_svg[g]&&c.push(this.data_svg[g]);try{this.data_svg[g]=y?this.root.polygon(u,this.lines[g].style):this.root.polyline(u,this.lines[g].style)}catch(t){i.error("[Chart] Failed to create poly for "+this.rect.id)}void 0!==this.txt[g]&&(this.txt[g].textContent=t.srSiFormatNum(_[g],void 0===this.lines[g].unit?"":this.lines[g].unit,"-"))}for(;c.length;){var E=c.shift();this.root.remove(E)}e!==this.last_state&&(this.opts.cls.state.forEach(function(t){this.rect.classList.remove(t+this.last_state)},this),this.opts.cls.state.forEach(function(t){this.rect.classList.add(t+e)},this),this.last_state=e,s.srStateChanged(this.rect.parentElement.parentElement.id,this.rect.id,e))},h});