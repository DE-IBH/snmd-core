define(["snmd-core/js/Core","jquery","paho","js-logger"],function(t,n,i,e){"use strict";var s=null,o=function(){if(null!==s)throw new Error("Cannot instantiate more than one instance, use getInstance()!");this.client=void 0,this.flashTO=void 0,this.reconnTO=void 0,this.topics={}};return o.getInstance=function(){return null===s&&(s=new o),s},o.prototype.srReconnect=function(){e.debug("[MQTT] Reconnecting..."),this.srConnect()},o.prototype.srRegisterTopic=function(t,n){"undefined"==typeof this.topics&&(this.topics={}),"undefined"==typeof this.topics[t]?(this.topics[t]=[n],"undefined"!=typeof this.client&&this.client.isConnected()&&this.client.subscribe(t)):this.topics[t].push(n)},o.prototype.srStatus=function(t){n("#snmd-hb").css("background",t)},o.prototype.srConnect=function(){this.srStatus("yellow"),e.debug("[MQTT] Connecting to broker at "+this.broker_host+":"+this.broker_port+"..."),this.client=new i.MQTT.Client(this.broker_host,this.broker_port,"",this.clientId),this.client.disconnect=function(){e.error("[MQTT] Disconnected"),this.srStatus("#7f0000")}.bind(this),this.client.onConnectionLost=function(t){this.srStatus("#ff0000"),e.error("[MQTT] Connection lost: "+t.errorMessage),this.reconnTO&&clearTimeout(this.reconnTO),this.srStatus("orange"),this.reconnTO=setTimeout(this.srConnect.bind(this),5e3)}.bind(this),this.client.onMessageArrived=function(t){if(this.srStatus("#00ff00"),setTimeout(function(){this.srStatus("#007f00")}.bind(this),100),"undefined"!=typeof this.topics[t.destinationName]){var n;for(n=0;n<this.topics[t.destinationName].length;n++){var i=this.topics[t.destinationName][n];try{i.handleUpdate.call(i,t.destinationName,t.payloadString)}catch(s){return e.error("[MQTT] Failure handling update on '"+t.destinationName+"' in class '"+i.constructor.name+": "+s.message),void e.warn(s.stack)}}}else e.warn("[MQTT] Received MQTT message for unexpected topic '"+t.destinationName+"'!");return 1}.bind(this),this.client.connect({onSuccess:function(){e.info("[MQTT] Connected to mqtt://"+this.broker_host+":"+this.broker_port),this.srStatus("#7f0000"),Object.keys(this.topics).forEach(function(t){this.client.subscribe(t)},this),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this),onFailure:function(){this.reconnTO&&clearTimeout(this.reconnTO),this.srStatus("orange"),this.reconnTO=setTimeout(this.srConnect.bind(this),5e3),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this)})},o.prototype.srInit=function(t,n,i){"undefined"==typeof i&&(i="RND"+Math.floor(16777215*Math.random()).toString(16)),this.broker_host=t,this.broker_port=Number(n),this.clientId=i,this.srConnect()},o.getInstance()});
//# sourceMappingURL=dist/js/MQTT.map