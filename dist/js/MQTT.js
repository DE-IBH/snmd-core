define(["snmd-core/js/Core","jquery","paho","js-logger"],function(t,i,n,s){"use strict";var e=null,o=function(){if(null!==e)throw new Error("Cannot instantiate more than one instance, use getInstance()!");this.client=void 0,this.flashTO=void 0,this.reconnTO=void 0,this.topics={}};return o.getInstance=function(){return null===e&&(e=new o),e},o.prototype.srReconnect=function(){s.debug("[MQTT] Reconnecting..."),this.srStatus("Gold"),this.srConnect()},o.prototype.srRegisterTopic=function(t,i){void 0===this.topics&&(this.topics={}),void 0===this.topics[t]?(this.topics[t]=[i],void 0!==this.client&&this.client.isConnected()&&this.client.subscribe(t)):this.topics[t].push(i)},o.prototype.srStatus=function(t){i("#snmd-hb").css("background",t)},o.prototype.srConnect=function(){this.srStatus("yellow"),s.debug("[MQTT] Connecting to broker at "+this.broker_uri+"..."),this.client=new n.MQTT.Client(this.broker_uri,this.clientId),this.client.disconnect=function(){s.error("[MQTT] Disconnected"),this.srStatus("Crimson")}.bind(this),this.client.onConnectionLost=function(t){this.srStatus("Crimson"),s.error("[MQTT] Connection lost: "+t.errorMessage),this.reconnTO&&window.clearTimeout(this.reconnTO),this.srStatus("orange"),this.reconnTO=window.setTimeout(this.srConnect.bind(this),5e3)}.bind(this),this.client.onMessageArrived=function(t){if(this.srStatus("LimeGreen"),window.setTimeout(function(){this.srStatus("#007f00")}.bind(this),100),void 0!==this.topics[t.destinationName]){var i;for(i=0;i<this.topics[t.destinationName].length;i++){var n=this.topics[t.destinationName][i];try{n.handleUpdate.call(n,t.destinationName,t.payloadString)}catch(i){return s.error("[MQTT] Failure handling update on '"+t.destinationName+"' in class '"+n.constructor.name+": "+i.message),void s.warn(i.stack)}}}else s.warn("[MQTT] Received MQTT message for unexpected topic '"+t.destinationName+"'!");return 1}.bind(this),this.client.connect({onSuccess:function(){s.info("[MQTT] Connected to "+this.broker_uri),this.srStatus("#007f00"),Object.keys(this.topics).forEach(function(t){this.client.subscribe(t)},this),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this),onFailure:function(){this.reconnTO&&window.clearTimeout(this.reconnTO),this.srStatus("Crimson"),this.reconnTO=window.setTimeout(this.srConnect.bind(this),5e3),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this)})},o.prototype.srInit=function(t,i){void 0===i&&(i="RND"+Math.floor(16777215*Math.random()).toString(16)),this.broker_uri=t,this.clientId=i,this.srStatus("Gold"),this.srConnect()},o.getInstance()});