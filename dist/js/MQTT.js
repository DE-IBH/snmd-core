define(["snmd-core/js/Core","jquery","paho","js-logger"],function(t,n,i,s){"use strict";var e=null,o=function(){if(null!==e)throw new Error("Cannot instantiate more than one instance, use getInstance()!");this.client=void 0,this.flashTO=void 0,this.reconnTO=void 0,this.topics={}};return o.getInstance=function(){return null===e&&(e=new o),e},o.prototype.srReconnect=function(){s.debug("[MQTT] Reconnecting..."),this.srConnect()},o.prototype.srRegisterTopic=function(t,n){void 0===this.topics&&(this.topics={}),void 0===this.topics[t]?(this.topics[t]=[n],void 0!==this.client&&this.client.isConnected()&&this.client.subscribe(t)):this.topics[t].push(n)},o.prototype.srStatus=function(t){n("#snmd-hb").css("background",t)},o.prototype.srConnect=function(){this.srStatus("yellow"),s.debug("[MQTT] Connecting to broker at "+this.broker_uri+"..."),this.client=new i.MQTT.Client(this.broker_uri,this.clientId),this.client.disconnect=function(){s.error("[MQTT] Disconnected"),this.srStatus("#7f0000")}.bind(this),this.client.onConnectionLost=function(t){this.srStatus("#ff0000"),s.error("[MQTT] Connection lost: "+t.errorMessage),this.reconnTO&&clearTimeout(this.reconnTO),this.srStatus("orange"),this.reconnTO=setTimeout(this.srConnect.bind(this),5e3)}.bind(this),this.client.onMessageArrived=function(t){if(this.srStatus("#00ff00"),setTimeout(function(){this.srStatus("#007f00")}.bind(this),100),void 0!==this.topics[t.destinationName]){var n;for(n=0;n<this.topics[t.destinationName].length;n++){var i=this.topics[t.destinationName][n];try{i.handleUpdate.call(i,t.destinationName,t.payloadString)}catch(n){return s.error("[MQTT] Failure handling update on '"+t.destinationName+"' in class '"+i.constructor.name+": "+n.message),void s.warn(n.stack)}}}else s.warn("[MQTT] Received MQTT message for unexpected topic '"+t.destinationName+"'!");return 1}.bind(this),this.client.connect({onSuccess:function(){s.info("[MQTT] Connected to "+this.broker_uri),this.srStatus("#7f0000"),Object.keys(this.topics).forEach(function(t){this.client.subscribe(t)},this),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this),onFailure:function(){this.reconnTO&&clearTimeout(this.reconnTO),this.srStatus("orange"),this.reconnTO=setTimeout(this.srConnect.bind(this),5e3),require("snmd-core/js/Core").snmdFinishLoading()}.bind(this)})},o.prototype.srInit=function(t,n){void 0===n&&(n="RND"+Math.floor(16777215*Math.random()).toString(16)),this.broker_uri=t,this.clientId=n,this.srConnect()},o.getInstance()});